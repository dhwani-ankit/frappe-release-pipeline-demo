name: PR Checklist Bot

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  add-checklist:
    name: Add DevOps Checklist to PR
    runs-on: ubuntu-latest
    if: github.event.pull_request.base.ref == 'main'
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Add DevOps Review Checklist
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const prAuthor = context.payload.pull_request.user.login;
            
            const checklist = `## ðŸ” DevOps Review Checklist

**âš ï¸ DevOps Team: Please manually check each item during review**

### âœ… Automated Checks Verification
- [ ] **CI/CD Pipeline**: All GitHub Actions checks are passing
- [ ] **Linting**: Flake8 and ESLint checks passed
- [ ] **Unit Tests**: All pytest tests are passing
- [ ] **SonarQube**: Quality gate passed and reviewed
- [ ] **No Merge Conflicts**: Branch is up to date with main

### âœ… Code Quality Review
- [ ] **Code Standards**: Code follows project conventions
- [ ] **Code Review**: Code is readable and well-structured
- [ ] **No Security Issues**: Security scan reviewed and approved
- [ ] **No Sensitive Data**: No API keys, passwords, or secrets exposed
- [ ] **Dependencies**: All dependencies are secure and up to date

### âœ… Testing Verification
- [ ] **Test Coverage**: Adequate test coverage maintained
- [ ] **Integration Tests**: Integration tests pass (if applicable)
- [ ] **Manual Testing**: Manual testing completed (if required)
- [ ] **Breaking Changes**: No breaking changes OR breaking changes documented

### âœ… Deployment Readiness
- [ ] **Deployment Notes**: Deployment instructions reviewed
- [ ] **Database Migrations**: Migrations tested and backward compatible
- [ ] **Environment Variables**: New variables documented
- [ ] **Configuration**: No hardcoded values, all config externalized
- [ ] **Rollback Plan**: Rollback strategy considered (if major changes)

### âœ… Documentation
- [ ] **Code Comments**: Code is properly commented
- [ ] **README**: README updated if needed
- [ ] **Changelog**: Changelog updated (if applicable)
- [ ] **Migration Guide**: Migration notes added (if database changes)

### âœ… Final Approval
- [ ] **All Comments Addressed**: All review comments resolved
- [ ] **No Outstanding Issues**: No blocking issues remaining
- [ ] **PR Description**: PR description is complete and clear
- [ ] **Ready to Merge**: PR is approved and ready for merge

---

**DevOps Reviewer:** @_________________  
**Review Date:** _________________  
**PR Author:** @${prAuthor}  
**PR Number:** #${prNumber}

**Review Guidelines:** See [\`.github/DEVOPS_CHECKLIST.md\`](.github/DEVOPS_CHECKLIST.md) for detailed review process.`;

            // Check if checklist comment already exists
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.data.find(
              comment => 
                comment.user.type === 'Bot' && 
                comment.body.includes('DevOps Review Checklist')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: checklist
              });
              console.log('Updated existing checklist comment');
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: checklist
              });
              console.log('Created new checklist comment');
            }

